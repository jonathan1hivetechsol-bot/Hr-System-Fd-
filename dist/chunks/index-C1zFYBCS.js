import{d as e,r as t,j as a,e as s,R as r,f as i,n as l,o as n,L as o,P as d}from"./vendor-react-DP1fVbuu.js";import{u as m,a as c,s as h}from"../index-BZeppaX_.js";import{r as p,u,d as g}from"./vendor-firebase-Dc8JVVU0.js";import{l as x}from"./logo-1JtIC0mN.js";import"./vendor-icons-DoxuJXhj.js";const f={maxWidth:1200,maxHeight:1200,quality:.8,maxSizeKB:500};async function j(e,t={},a=0){const s={...f,...t};return new Promise((r,i)=>{if(e.size<1024*(s.maxSizeKB||500))return void r(e);const l=new FileReader,n=setTimeout(()=>{l.abort(),a<3?j(e,t,a+1).then(r).catch(i):i(new Error("Image compression timeout after retries"))},1e4);l.onload=t=>{clearTimeout(n);try{const l=new Image;l.onload=()=>{try{const t=document.createElement("canvas");let n=l.width,o=l.height;s.maxWidth&&n>s.maxWidth&&(o=o*s.maxWidth/n,n=s.maxWidth),s.maxHeight&&o>s.maxHeight&&(n=n*s.maxHeight/o,o=s.maxHeight),t.width=n,t.height=o;const d=t.getContext("2d");if(!d)throw new Error("Failed to get canvas context");d.drawImage(l,0,0,n,o),t.toBlob(t=>{try{if(!t)throw new Error("Canvas blob is null");const l=new File([t],e.name,{type:"image/jpeg",lastModified:Date.now()}),n=l.size/1024;if(s.maxSizeKB&&n>s.maxSizeKB&&(s.quality||.8)>.3){const e=.85*(s.quality||.8);return void j(l,{...s,quality:e},a).then(r).catch(i)}r(l)}catch(l){i(l)}},"image/jpeg",s.quality||.8)}catch(t){i(t)}},l.onerror=()=>{i(new Error("Failed to load image"))},l.src=t.target?.result}catch(l){i(l)}},l.onerror=()=>{clearTimeout(n),i(new Error("Failed to read file"))},l.readAsDataURL(e)})}async function b(e,t={}){try{return await Promise.all(e.map(e=>j(e,t)))}catch(a){throw a}}const y=()=>{const a=e(),{user:s,userProfile:r}=m(),[i,l]=t.useState(!1),[n,o]=t.useState(0),[d,x]=t.useState({phone:"",address:"",dateOfBirth:"",position:"",department:"",designations:"",profileImages:[]}),[f,j]=t.useState([]),[y,N]=t.useState({});return{formData:d,errors:y,loading:i,uploadProgress:n,imagePreviews:f,handleChange:e=>{const{name:t,value:a}=e.target;x(e=>({...e,[t]:a})),y[t]&&N(e=>{const a={...e};return delete a[t],a})},handleImageChange:e=>{const t=Array.from(e.target.files||[]).slice(0,2),a=[],s=[];let r=!1;for(const i of t){if(i.size>10485760){N(e=>({...e,profileImage:`File "${i.name}" is too large (${(i.size/1048576).toFixed(1)}MB). Max 10MB per file.`})),r=!0;break}if(!["image/jpeg","image/png","image/webp"].includes(i.type)){N(e=>({...e,profileImage:`File "${i.name}" format not supported. Use JPG, PNG or WebP.`})),r=!0;break}s.push(i);const e=new FileReader;e.onloadend=e=>{e.target?.result&&(a.push(e.target.result),a.length===t.length&&j(a))},e.onerror=()=>{N(e=>({...e,profileImage:`Failed to read file "${i.name}"`})),r=!0},e.readAsDataURL(i)}!r&&s.length>0&&(x(e=>({...e,profileImages:s})),y.profileImage&&N(e=>{const t={...e};return delete t.profileImage,t}))},removeImage:e=>{const t=f.filter((t,a)=>a!==e),a=d.profileImages.filter((t,a)=>a!==e);j(t),x(e=>({...e,profileImages:a}))},handleSubmit:async e=>{if(e.preventDefault(),!(()=>{const e={};return d.phone.trim()||(e.phone="Phone number is required"),d.address.trim()||(e.address="Address is required"),d.dateOfBirth||(e.dateOfBirth="Date of birth is required"),d.position.trim()||(e.position="Position is required"),d.department.trim()||(e.department="Department is required"),0===d.profileImages.length&&(e.profileImage="At least one profile image is required"),N(e),0===Object.keys(e).length})())return;l(!0),N({});const t=setTimeout(()=>{l(!1),N({submit:"Profile completion took too long. Please check your connection and try again."}),o(0)},12e4);try{if(!s)return clearTimeout(t),N({submit:"User not authenticated. Please login again."}),void l(!1);const e=await(async()=>{if(0===d.profileImages.length||!s)return null;try{o(10);let t=[];try{t=await b(d.profileImages,{maxWidth:1200,maxHeight:1200,quality:.75,maxSizeKB:400})}catch(e){t=d.profileImages}o(20);const a=[];for(let e=0;e<t.length;e++){const r=t[e],i=`profile-${s.uid}-${e}-${Date.now()}`,l=p(h,`employee-profiles/${s.uid}/${i}`),n=u(l,r),d=await new Promise((t,a)=>{let s=null,r=!1;s=setTimeout(()=>{r||a(new Error("Image upload took too long. Check internet and try again."))},12e4),n.on("state_changed",t=>{const a=t.bytesTransferred/t.totalBytes*100,s=35*e+.35*a+20;o(Math.min(s,95))},e=>{if(s&&clearTimeout(s),!r){r=!0;const t="storage/unauthenticated"===e.code?"Authentication failed. Please login again.":"storage/quota-exceeded"===e.code?"Storage quota exceeded. Contact admin.":e.message||"Upload failed";a(new Error(t))}},async()=>{if(s&&clearTimeout(s),!r){r=!0;try{const e=await g(n.snapshot.ref);t(e)}catch(e){a(new Error("Failed to process uploaded file"))}}})});a.push(d)}return o(95),a}catch(t){return o(0),null}})();if(!e||0===e.length)return clearTimeout(t),N({submit:"Failed to upload profile images. Please ensure your images are in JPG, PNG or WebP format and less than 10MB. Check your internet connection and try again."}),void l(!1);const r={phone:d.phone,address:d.address,dateOfBirth:d.dateOfBirth,position:d.position,department:d.department,designations:d.designations,profileImages:e,profileImage:e[0],profileComplete:!0,updatedAt:new Date},i=await c("employees",s.uid,r);i.success?(await c("users",s.uid,{profileComplete:!0,updatedAt:new Date}).catch(e=>{}),clearTimeout(t),setTimeout(()=>{a("/dashboards/dashboard/employee",{replace:!0})},500)):(clearTimeout(t),N({submit:i.error||"Failed to update profile. Please try again."}),l(!1))}catch(r){clearTimeout(t),N({submit:r instanceof Error?r.message:"An unexpected error occurred. Please try again."}),l(!1)}finally{o(0)}}}};(new Date).getFullYear();const N=["Sales","Social Media","SEO and Dev","Cleaning","Helper","Assistant","Accountant","Manager","HR","Worker"],v=()=>{const{formData:e,errors:t,loading:m,uploadProgress:c,imagePreviews:h,handleChange:p,handleImageChange:u,removeImage:g,handleSubmit:f}=y();return a.jsx("div",{className:"bg-gradient2 min-vh-100 align-items-center d-flex justify-content-center pt-2 pt-sm-5 pb-4 pb-sm-5",children:a.jsx(s,{children:a.jsx(r,{className:"justify-content-center",children:a.jsx(i,{lg:10,xl:8,children:a.jsx(l,{children:a.jsxs(n,{className:"p-4 p-sm-5",children:[a.jsx("div",{className:"mx-auto mb-4",children:a.jsx(o,{to:"/",className:"d-flex",children:a.jsx("img",{src:x,className:"align-self-center",alt:"logo-img",height:30})})}),a.jsx("h4",{className:"h4 mb-1 mt-4",children:"Complete Your Profile"}),a.jsx("p",{className:"text-muted mb-4",children:"Please fill in your profile information to get started."}),a.jsxs("form",{onSubmit:f,children:[a.jsxs(r,{children:[a.jsx(i,{md:6,children:a.jsxs("div",{className:"mb-3",children:[a.jsxs("label",{htmlFor:"phone",className:"form-label",children:["Phone Number ",a.jsx("small",{children:"*"})]}),a.jsx("input",{type:"tel",className:"form-control",id:"phone",placeholder:"Phone Number",name:"phone",value:e.phone,onChange:p}),t.phone&&a.jsx("small",{className:"text-danger",children:t.phone})]})}),a.jsx(i,{md:6,children:a.jsxs("div",{className:"mb-3",children:[a.jsxs("label",{htmlFor:"dateOfBirth",className:"form-label",children:["Date of Birth ",a.jsx("small",{children:"*"})]}),a.jsx("input",{type:"date",className:"form-control",id:"dateOfBirth",name:"dateOfBirth",value:e.dateOfBirth,onChange:p}),t.dateOfBirth&&a.jsx("small",{className:"text-danger",children:t.dateOfBirth})]})})]}),a.jsxs("div",{className:"mb-3",children:[a.jsxs("label",{htmlFor:"address",className:"form-label",children:["Address ",a.jsx("small",{children:"*"})]}),a.jsx("textarea",{className:"form-control",id:"address",placeholder:"Enter your address",name:"address",value:e.address,onChange:p,rows:3}),t.address&&a.jsx("small",{className:"text-danger",children:t.address})]}),a.jsxs(r,{children:[a.jsx(i,{md:6,children:a.jsxs("div",{className:"mb-3",children:[a.jsxs("label",{htmlFor:"position",className:"form-label",children:["Position ",a.jsx("small",{children:"*"})]}),a.jsx("input",{type:"text",className:"form-control",id:"position",placeholder:"Your Position",name:"position",value:e.position,onChange:p}),t.position&&a.jsx("small",{className:"text-danger",children:t.position})]})}),a.jsx(i,{md:6,children:a.jsxs("div",{className:"mb-3",children:[a.jsxs("label",{htmlFor:"department",className:"form-label",children:["Department ",a.jsx("small",{children:"*"})]}),a.jsxs("select",{className:"form-control",id:"department",name:"department",value:e.department,onChange:p,children:[a.jsx("option",{value:"",children:"Select Department"}),N.map(e=>a.jsx("option",{value:e,children:e},e))]}),t.department&&a.jsx("small",{className:"text-danger",children:t.department})]})})]}),a.jsxs("div",{className:"mb-3",children:[a.jsx("label",{htmlFor:"designations",className:"form-label",children:"Designations / Skills"}),a.jsx("input",{type:"text",className:"form-control",id:"designations",placeholder:"e.g., Software Developer, Team Lead",name:"designations",value:e.designations,onChange:p})]}),a.jsxs("div",{className:"mb-3",children:[a.jsxs("label",{htmlFor:"profileImage",className:"form-label",children:["Profile Pictures (Up to 2) ",a.jsx("small",{children:"*"})]}),a.jsx("div",{className:"border-2 border-dashed p-4 text-center rounded",style:{cursor:"pointer"},children:h.length>0?a.jsxs("div",{children:[a.jsx("div",{className:"row g-3 mb-3",children:h.map((e,t)=>a.jsx("div",{className:"col-md-6",children:a.jsxs("div",{className:"position-relative",children:[a.jsx("img",{src:e,alt:`Preview ${t+1}`,className:"img-fluid rounded",style:{maxHeight:"150px",objectFit:"cover",width:"100%"}}),a.jsx("button",{type:"button",className:"btn btn-sm btn-danger position-absolute top-0 end-0 m-2",onClick:()=>g(t),title:"Remove image",children:"Ã—"})]})},t))}),a.jsxs("p",{className:"text-muted small mb-2",children:[h.length," of 2 photos selected"]}),a.jsx("input",{type:"file",className:"form-control",id:"profileImage",accept:"image/*",multiple:!0,onChange:u,style:{display:"none"}}),h.length<2&&a.jsx("button",{type:"button",className:"btn btn-sm btn-outline-primary me-2",onClick:()=>document.getElementById("profileImage")?.click(),children:"Add More Photos"}),a.jsx("button",{type:"button",className:"btn btn-sm btn-outline-secondary",onClick:()=>{const e=document.getElementById("profileImage");e&&(e.value=""),g(0)},children:"Clear All"})]}):a.jsxs("div",{onClick:()=>document.getElementById("profileImage")?.click(),children:[a.jsxs("svg",{className:"mb-3",width:"48",height:"48",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[a.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"}),a.jsx("circle",{cx:"8.5",cy:"8.5",r:"1.5"}),a.jsx("polyline",{points:"21 15 16 10 5 21"})]}),a.jsx("p",{className:"text-muted mb-2",children:"Click to upload profile pictures"}),a.jsx("p",{className:"small text-muted mb-0",children:"(JPG, PNG - Max 5MB per file, up to 2 photos)"}),a.jsx("input",{type:"file",className:"form-control",id:"profileImage",accept:"image/*",multiple:!0,onChange:u,style:{display:"none"}})]})}),t.profileImage&&a.jsx("small",{className:"text-danger d-block mt-2",children:t.profileImage})]}),c>0&&c<100&&a.jsxs("div",{className:"mb-3",children:[a.jsxs("p",{className:"text-muted mb-2",children:["Uploading... ",Math.round(c),"%"]}),a.jsx(d,{now:c})]}),t.submit&&a.jsx("div",{className:"alert alert-danger alert-dismissible fade show",role:"alert",children:t.submit}),a.jsx("div",{className:"mb-0 text-center d-grid gap-2",children:a.jsx("button",{className:"btn btn-primary",type:"submit",disabled:m||c>0,children:m?"Completing Profile...":"Complete Profile & Continue"})})]})]})})})})})})};export{v as default};
